name: Update Cloudflare Gateway Filters

on:
  schedule:
    - cron: '30 20 * * *'  # 毎日 AM 5:30 JST
  workflow_dispatch: # 手動実行ボタン

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout latest code
        uses: actions/checkout@v4
        with:
          repository: mrrfv/cloudflare-gateway-pihole-scripts
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
        
      - name: Delete old rules and lists
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          node cf_gateway_rule_delete.js || true
          node cf_list_delete.js || true
      
      - name: Generate dynamic 280blocker URL
        run: |
          CURRENT_YYYYMM=$(date +%Y%m)
          echo "280BLOCKER_URL=https://280blocker.net/files/280blocker_domain_ag_${CURRENT_YYYYMM}.txt" >> $GITHUB_ENV
          echo "Generated 280blocker URL: https://280blocker.net/files/280blocker_domain_ag_${CURRENT_YYYYMM}.txt"
      
      - name: Merge blocklist URLs
        run: |
          if [ -n "${{ vars.BLOCKLIST_URLS }}" ]; then
            MERGED_URLS="${{ vars.BLOCKLIST_URLS }}
          ${{ env.280BLOCKER_URL }}"
          else
            MERGED_URLS="${{ env.280BLOCKER_URL }}"
          fi
          echo "BLOCKLIST_URLS<<EOF" >> $GITHUB_ENV
          echo "$MERGED_URLS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
      - name: Download filter lists
        env:
          BLOCKLIST_URLS: ${{ env.BLOCKLIST_URLS }}
          ALLOWLIST_URLS: ${{ vars.ALLOWLIST_URLS }}
        run: node download_lists.js
        
      - name: Create new lists
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_LIST_ITEM_LIMIT: ${{ secrets.CLOUDFLARE_LIST_ITEM_LIMIT }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: node cf_list_create.js
        
      - name: Create gateway rule
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          BLOCK_PAGE_ENABLED: ${{ vars.BLOCK_PAGE_ENABLED }}
        run: node cf_gateway_rule_create.js

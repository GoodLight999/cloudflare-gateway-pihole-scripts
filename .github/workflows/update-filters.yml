name: Update Cloudflare Gateway Filters

on:
  schedule:
    - cron: '30 20 * * *'  # 毎日 AM 5:30 JST
  workflow_dispatch: # 手動実行ボタン

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout latest code
        uses: actions/checkout@v4
        with:
          repository: mrrfv/cloudflare-gateway-pihole-scripts
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
        
      - name: Delete old rules and lists
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          node cf_gateway_rule_delete.js || true
          node cf_list_delete.js || true
      
      - name: Check 280blocker enable flag
        run: |
          # 大文字小文字を無視して判定
          ENABLE_FLAG=$(echo "${{ vars.ENABLE_280BLOCKER }}" | tr '[:upper:]' '[:lower:]')
          
          if [[ "$ENABLE_FLAG" =~ ^(true|1|yes|on)$ ]]; then
            echo "ENABLE_280BLOCKER_NORMALIZED=true" >> $GITHUB_ENV
            echo "ℹ 280blocker is enabled by configuration"
          else
            echo "ENABLE_280BLOCKER_NORMALIZED=false" >> $GITHUB_ENV
            echo "ℹ 280blocker is disabled by configuration"
          fi
      
      - name: Generate and validate 280blocker URL
        if: env.ENABLE_280BLOCKER_NORMALIZED == 'true'
        run: |
          CURRENT_YYYYMM=$(date +%Y%m)
          BLOCKER_URL="https://280blocker.net/files/280blocker_domain_ag_${CURRENT_YYYYMM}.txt"
          
          echo "Checking 280blocker URL: $BLOCKER_URL"
          
          # URL の正常性チェック（タイムアウト10秒、リダイレクト対応）
          HTTP_CODE=$(curl -L -s -o /dev/null -w "%{http_code}" --max-time 10 "$BLOCKER_URL" 2>&1 || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✓ 280blocker URL is accessible (HTTP $HTTP_CODE)"
            echo "BLOCKER_280_URL=$BLOCKER_URL" >> $GITHUB_ENV
            echo "USE_280BLOCKER=true" >> $GITHUB_ENV
          else
            echo "⚠ 280blocker URL returned HTTP $HTTP_CODE, trying previous month..."
            
            # 前月のURLでリトライ
            PREV_MONTH=$(date -d "1 month ago" +%Y%m)
            BLOCKER_URL_PREV="https://280blocker.net/files/280blocker_domain_ag_${PREV_MONTH}.txt"
            
            HTTP_CODE_PREV=$(curl -L -s -o /dev/null -w "%{http_code}" --max-time 10 "$BLOCKER_URL_PREV" 2>&1 || echo "000")
            
            if [ "$HTTP_CODE_PREV" = "200" ]; then
              echo "✓ Previous month 280blocker URL is accessible (HTTP $HTTP_CODE_PREV)"
              echo "BLOCKER_280_URL=$BLOCKER_URL_PREV" >> $GITHUB_ENV
              echo "USE_280BLOCKER=true" >> $GITHUB_ENV
            else
              echo "⚠ 280blocker is completely unreachable (current: $HTTP_CODE, previous: $HTTP_CODE_PREV)"
              echo "⚠ Proceeding without 280blocker - will use other blocklists only"
              echo "USE_280BLOCKER=false" >> $GITHUB_ENV
            fi
          fi
      
      - name: Merge blocklist URLs
        run: |
          # Repository Variables の内容を取得
          BASE_URLS="${{ vars.BLOCKLIST_URLS }}"
          
          # 280blocker の有効化チェック（2段階）
          if [ "${{ env.ENABLE_280BLOCKER_NORMALIZED }}" = "true" ] && [ "${{ env.USE_280BLOCKER }}" = "true" ]; then
            if [ -n "$BASE_URLS" ]; then
              MERGED_URLS="${BASE_URLS}
          ${{ env.BLOCKER_280_URL }}"
            else
              MERGED_URLS="${{ env.BLOCKER_280_URL }}"
            fi
            echo "✓ 280blocker added to blocklist"
          else
            MERGED_URLS="$BASE_URLS"
            if [ "${{ env.ENABLE_280BLOCKER_NORMALIZED }}" != "true" ]; then
              echo "ℹ 280blocker is disabled by ENABLE_280BLOCKER variable"
            else
              echo "⚠ Proceeding without 280blocker (unreachable)"
            fi
          fi
          
          # 複数行環境変数の設定
          echo "BLOCKLIST_URLS<<EOF" >> $GITHUB_ENV
          echo "$MERGED_URLS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # デバッグ出力（URLは表示しない、行数のみ）
          URL_COUNT=$(echo "$MERGED_URLS" | grep -c "^http" || echo "0")
          echo "Total blocklist URLs: $URL_COUNT"
          
      - name: Download filter lists
        env:
          BLOCKLIST_URLS: ${{ env.BLOCKLIST_URLS }}
          ALLOWLIST_URLS: ${{ vars.ALLOWLIST_URLS }}
        run: node download_lists.js
        
      - name: Create new lists
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_LIST_ITEM_LIMIT: ${{ secrets.CLOUDFLARE_LIST_ITEM_LIMIT }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: node cf_list_create.js
        
      - name: Create gateway rule
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          BLOCK_PAGE_ENABLED: ${{ vars.BLOCK_PAGE_ENABLED }}
        run: node cf_gateway_rule_create.js
